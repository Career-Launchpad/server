{"version":3,"sources":["../../src/lib/wrap.js"],"names":["wrapNodeJs","fn","ctx","newHandlerCode","sls","service","tenant","app","appUid","tenantUid","provider","getStage","name","timeout","entryOrig","handlerOrig","fs","writeFileSync","path","join","config","servicePath","entryNew","cli","log","functions","state","func","runtime","includes","stage","entry","handler","split","key","handlerNew","pathAssets","pathExistsSync","removeSync","ensureDirSync","pathSdk","resolve","__dirname","pathSdkDest","copySync","_","get","readFile","package","artifact","zipData","JSZip","loadAsync","zip","wrapperData","file","undefined","include","push"],"mappings":"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","sourcesContent":["/*\n * Wrap\n * - Bundles the ServerlessSDK into your functions\n * - Wraps your function handlers with the ServerlessSDK\n */\n\nimport fs from 'fs-extra'\nimport path from 'path'\nimport _ from 'lodash'\nimport JSZip from 'jszip'\nimport { addTree, writeZip } from './zipTree'\n\n/*\n * Wrap Node.js Functions\n */\n\nexport const wrapNodeJs = (fn, ctx) => {\n  const newHandlerCode = `var serverlessSDK = require('./serverless-sdk/index.js')\nserverlessSDK = new serverlessSDK({\ntenantId: '${ctx.sls.service.tenant}',\napplicationName: '${ctx.sls.service.app}',\nappUid: '${ctx.sls.service.appUid}',\ntenantUid: '${ctx.sls.service.tenantUid}',\nserviceName: '${ctx.sls.service.service}',\nstageName: '${ctx.provider.getStage()}'})\nconst handlerWrapperArgs = { functionName: '${fn.name}', timeout: ${fn.timeout}}\ntry {\n  const userHandler = require('./${fn.entryOrig}.js')\n  module.exports.handler = serverlessSDK.handler(userHandler.${fn.handlerOrig}, handlerWrapperArgs)\n} catch (error) {\n  module.exports.handler = serverlessSDK.handler(() => { throw error }, handlerWrapperArgs)\n}\n`\n\n  // Create new handlers\n  fs.writeFileSync(path.join(ctx.sls.config.servicePath, `${fn.entryNew}.js`), newHandlerCode)\n}\n\nexport default async (ctx) => {\n  // Check if we support the provider\n  if (ctx.sls.service.provider.name !== 'aws') {\n    ctx.sls.cli.log(\n      'Warning: The Serverless Platform Plugin does not current support this provider.'\n    )\n  }\n\n  /*\n   * Prepare Functions\n   */\n  const { functions } = ctx.sls.service\n  ctx.state.functions = {}\n  for (const func in functions) {\n    const runtime = functions[func].runtime\n      ? functions[func].runtime\n      : ctx.sls.service.provider.runtime\n    if (!runtime.includes('nodejs')) {\n      continue\n    }\n\n    // the default is 6s: https://serverless.com/framework/docs/providers/aws/guide/serverless.yml/\n    const timeout = functions[func].timeout ? functions[func].timeout : 6\n\n    // Process name\n    let name\n    if (functions[func].name) {\n      ;({ name } = functions[func])\n    } else {\n      name = `${ctx.sls.service.service}-${ctx.sls.service.provider.stage}-${func}`\n    }\n\n    // Process handler\n    const entry = functions[func].handler.split('.')[0]\n    const handler = functions[func].handler.split('.')[1]\n\n    ctx.state.functions[func] = {\n      key: func,\n      name: name,\n      runtime: runtime,\n      timeout: timeout,\n      entryOrig: entry,\n      handlerOrig: handler,\n      entryNew: `s-${func}`,\n      handlerNew: `handler`\n    }\n  }\n\n  /*\n   * Wrap Functions\n   */\n\n  ctx.state.pathAssets = path.join(ctx.sls.config.servicePath, 'serverless-sdk')\n\n  // Clear existing handler dir\n  if (fs.pathExistsSync(ctx.state.pathAssets)) {\n    fs.removeSync(ctx.state.pathAssets)\n  }\n\n  // Create new handler dir\n  fs.ensureDirSync(ctx.state.pathAssets)\n\n  // Copy SDK\n  const pathSdk = path.resolve(__dirname, '../../sdk-js/dist/index.js')\n  const pathSdkDest = path.join(ctx.state.pathAssets, './index.js')\n  fs.copySync(pathSdk, pathSdkDest)\n\n  // Prepare & Copy Function Handlers\n  for (var fn in ctx.state.functions) {\n    const func = ctx.state.functions[fn]\n\n    if (!func.runtime.includes('nodejs')) {\n      return\n    }\n\n    // Add the Serverless SDK wrapper around the function\n    wrapNodeJs(func, ctx)\n\n    // Re-assign the handler to point to the wrapper\n    ctx.sls.service.functions[fn].handler = `${func.entryNew}.${func.handlerNew}`\n\n    if (_.get(ctx.sls.service.functions[fn], 'package.artifact')) {\n      const zipData = await fs.readFile(ctx.sls.service.functions[fn].package.artifact)\n      const zip = await JSZip.loadAsync(zipData)\n      const wrapperData = await fs.readFile(\n        path.join(ctx.sls.config.servicePath, `${func.entryNew}.js`)\n      )\n      zip.file(`${func.entryNew}.js`, wrapperData)\n      await addTree(zip, 'serverless-sdk')\n      await writeZip(zip, ctx.sls.service.functions[fn].package.artifact)\n    } else if (\n      _.get(\n        ctx.sls.service.functions[fn],\n        'package.individually',\n        _.get(ctx.sls.service, 'package.individually', false)\n      )\n    ) {\n      // add include directives for handler file & sdk lib\n      if (ctx.sls.service.functions[fn].package === undefined) {\n        ctx.sls.service.functions[fn].package = {}\n      }\n      if (ctx.sls.service.functions[fn].package.include === undefined) {\n        ctx.sls.service.functions[fn].package.include = []\n      }\n      ctx.sls.service.functions[fn].package.include.push(`${func.entryNew}.js`)\n      ctx.sls.service.functions[fn].package.include.push('serverless-sdk/**')\n    }\n  }\n\n  // add include directives for handler file & sdk lib\n  if (!_.get(ctx.sls.service, 'package.individually', false)) {\n    if (ctx.sls.service.package === undefined) {\n      ctx.sls.service.package = {}\n    }\n    if (ctx.sls.service.package.include === undefined) {\n      ctx.sls.service.package.include = []\n    }\n    ctx.sls.service.package.include.push('s-*.js')\n    ctx.sls.service.package.include.push('serverless-sdk/**')\n  }\n}\n"],"file":"wrap.js"}